import{make as r,pipe as t,onPush as e,onEnd as n,subscribe as o,share as i,filter as a,map as u,tap as c,merge as s,mergeMap as f,takeUntil as p,makeSubject as v,onStart as d,take as h,toPromise as l}from"wonka";import{GraphQLError as y,print as m,visit as g}from"graphql";import w from"fast-json-stable-stringify";import O from"graphql-tag";import{createContext as b,useRef as k,useState as x,useCallback as E,useLayoutEffect as q,useMemo as N,__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED as S,useContext as _,useEffect as j}from"react";function P(){return(P=Object.assign||function(r){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n])}return r}).apply(this,arguments)}var D=function(r,t){var e="";return void 0!==r?e="[Network] "+r.message:(void 0!==t&&t.forEach(function(r){e+="[GraphQL] "+r.message+"\n"}),e.trim())},M=function(r){return"string"==typeof r?new y(r):"object"==typeof r&&r.message?new y(r.message,r.nodes,r.source,r.positions,r.path,r.originalError,r.extensions||{}):r};function Q(){return this.message}var C=function(r){function t(t){var e=t.networkError,n=t.response,o=(t.graphQLErrors||[]).map(M),i=D(e,o);r.call(this,i),this.name="CombinedError",this.message=i,this.graphQLErrors=o,this.networkError=e,this.response=n}return r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t,t.prototype.toString=Q,t}(Error),L=function(r){for(var t=5381,e=0,n=0|r.length;e<n;e++)t=(t<<5)+t+r.charCodeAt(e);return t>>>0},R=Object.create(null);function A(r,t){return r+(void 0!==t.name?t.name.value:"")}var W=function(r,t){var e=function(r){if(void 0!==r.__key)return r.__key;var t=r.definitions.reduce(A,"");if("production"!==process.env.NODE_ENV&&""!==t){var e=m(r);t in R?R[t]!==e&&console.warn("Warning: Encountered multiple DocumentNodes with the same name."):R[t]=e}""===t&&(t=m(r));var n=L(t);return r.__key=n,n}(r);return null==t?e:L(""+e+w(t))},F=function(r,t){var e="string"==typeof r?O([r]):r;return{key:W(e,t),query:e,variables:t||{}}},U=function(r,t){return P({},r,{context:P({},r.context,{meta:P({},r.context.meta,t)})})},$="undefined"==typeof window||!("HTMLElement"in window),T=function(r,t){if(void 0===t&&(t=[]),Array.isArray(r))r.forEach(function(r){return T(r,t)});else if("object"==typeof r&&null!==r)for(var e in r)if(Object.prototype.hasOwnProperty.call(r,e)){var n=r[e];"__typename"===e&&"string"==typeof n?t.push(n):"object"==typeof n&&null!==n&&T(n,t)}return t};function V(r,t,e){return e.indexOf(r)===t}var H=function(r){return T(r).filter(V)};function I(r){return"Field"===r.kind&&"__typename"===r.name.value}var G=function(r){return void 0!==r.selectionSet&&(r.selectionSet.selections.some(I)?r:P({},r,{selectionSet:P({},r.selectionSet,{selections:r.selectionSet.selections.concat([{kind:"Field",name:{kind:"Name",value:"__typename"}}])})}))},J=function(r){return g(r,{Field:G,InlineFragment:G,OperationDefinition:G})},Y=function(){},z=function(r){var t=r.operationName;return"subscription"!==t&&"query"!==t};function B(r){return""+r}var K=function(r){var t=r.error,e={data:r.data,error:void 0};return void 0!==t&&(e.error={networkError:""+t.networkError,graphQLErrors:t.graphQLErrors.map(B)}),e},X=function(r,t){var e=t.error,n={operation:r,data:t.data,error:void 0};return void 0!==e&&(n.error=new C({networkError:new Error(e.networkError),graphQLErrors:e.graphQLErrors})),n},Z=function(r){var e={},n=function(r){return!z(r)&&void 0!==e[r.key]};function o(r){return!n(r)}function f(r){return n(r)}function p(r){return X(r,e[r.key])}function v(r){var t=r.operation;if(!z(t)){var n=K(r);e[t.key]=n}}function d(r){delete e[r.operation.key]}var h=function(r){var e=r.client,n=r.forward;return function(r){var h=i(r),l=t(h,a(o),n),y=t(h,a(f),u(p));return e.suspense?l=t(l,c(v)):y=t(y,c(d)),s([l,y])}};return h.restoreData=function(r){return P(e,r)},h.extractData=function(){return P({},e)},r&&r.initialState&&h.restoreData(r.initialState),h},rr=function(r){var t=r.operationName;return"mutation"!==t&&"query"!==t};function tr(r){return P({},r,{query:J(r.query)})}function er(r){return rr(r)}function nr(r){return U(r,{cacheOutcome:"miss"})}var or=function(r){var e=r.forward,n=r.client,o=new Map,f=Object.create(null),p=tr,v=ar(o,f,n),d=ur(o,f),h=function(r){var t=r.context.requestPolicy;return"query"===r.operationName&&"network-only"!==t&&("cache-only"===t||o.has(r.key))};function l(r){return!rr(r)&&h(r)}function y(r){var t=r.context,e=o.get(r.key);return"cache-and-network"===t.requestPolicy&&ir(n,r),void 0!==e?P({},e,{operation:U(e.operation,{cacheOutcome:"hit"})}):{data:void 0,error:void 0,operation:U(r,{cacheOutcome:"miss"})}}function m(r){return!rr(r)&&!h(r)}function g(r){r.operation&&"mutation"===r.operation.operationName?v(r):r.operation&&"query"===r.operation.operationName&&d(r)}return function(r){var n=i(r),o=t(n,a(l),u(y)),f=t(s([t(n,a(m),u(p)),t(n,a(er))]),u(nr),e,c(g));return s([o,f])}},ir=function(r,t){return r.reexecuteOperation(P({},t,{context:P({},t.context,{requestPolicy:"network-only"})}))},ar=function(r,t,e){function n(t){if(r.has(t)){var n=r.get(t).operation;r.delete(t),ir(e,n)}}return function(r){var e=new Set;function o(r){return e.add(r)}H(r.data).forEach(function(r){var e=t[r]||(t[r]=new Set);e.forEach(o),e.clear()}),e.forEach(n)}},ur=function(r,t){return function(e){var n=e.operation;void 0!==e.data&&(r.set(n.key,e),H(e.data).forEach(function(r){(t[r]||(t[r]=new Set)).add(n.key)}))}},cr=function(r){return"subscription"===r.operationName};function sr(r){return!cr(r)}var fr=function(e){var n=e.forwardSubscription;function o(t){var e=n({key:t.key.toString(36),query:m(t.query),variables:t.variables,context:P({},t.context)});return r(function(r){var n=r[0],o=e.subscribe({next:function(r){return n({operation:t,data:r.data||void 0,error:Array.isArray(r.errors)?new C({graphQLErrors:r.errors,response:void 0}):void 0})},error:function(r){return n({operation:t,data:void 0,error:new C({networkError:r,response:void 0})})},complete:r[1]});return function(){return o.unsubscribe()}})}return function(r){var e=r.forward,n=o;return function(r){var o=i(r),u=t(o,a(cr),f(function(r){var e=r.key,i=t(o,a(function(r){return"teardown"===r.operationName&&r.key===e}));return t(n(r),p(i))})),c=t(o,a(sr),e);return s([u,c])}}};function pr(r){return console.log("[Exchange debug]: Incoming operation: ",r)}function vr(r){return console.log("[Exchange debug]: Completed operation: ",r)}var dr=function(r){var e=r.forward;return function(r){return t(r,c(pr),e,c(vr))}},hr=function(r){var e=r.forward,n=new Set,o=function(r){var t=r.key,e=r.operationName;if("teardown"===e)return n.delete(t),!0;if("query"!==e)return!0;var o=n.has(t);return n.add(t),!o},i=function(r){n.delete(r.operation.key)};return function(r){var n=t(r,a(o));return t(e(n),c(i))}};function lr(r){var t=r.operationName;return"query"===t||"mutation"===t}var yr=function(r){var e=r.forward,n=lr;function o(r){return!n(r)}return function(r){var u=i(r),c=t(u,a(n),f(function(r){var e=r.key,n=t(u,a(function(r){return"teardown"===r.operationName&&r.key===e}));return t(mr(r),p(n))})),v=t(u,a(o),e);return s([c,v])}},mr=function(t){if("subscription"===t.operationName)throw new Error("Received a subscription operation in the httpExchange. You are probably trying to create a subscription. Have you added a subscriptionExchange?");return r(function(r){var e=r[0],n=r[1],o="undefined"!=typeof AbortController?new AbortController:void 0,i=t.context,a="function"==typeof i.fetchOptions?i.fetchOptions():i.fetchOptions||{},u=P({body:JSON.stringify({query:m(t.query),variables:t.variables}),method:"POST"},a,{headers:P({"content-type":"application/json"},a.headers),signal:void 0!==o?o.signal:void 0}),c=Date.now();return gr(t,u).then(function(r){void 0!==r&&e(P({},r,{operation:U(r.operation,{networkLatency:Date.now()-c})})),n()}),function(){void 0!==o&&o.abort()}})},gr=function(r,t){var e;return fetch(r.context.url,t).then(function(r){return wr(t.redirect,e=r),e.json()}).then(function(t){return{operation:r,data:t.data,error:Array.isArray(t.errors)?new C({graphQLErrors:t.errors,response:e}):void 0}}).catch(function(t){if("AbortError"!==t.name)return{operation:r,data:void 0,error:new C({networkError:t,response:e})}})},wr=function(r,t){if(void 0===r&&(r="follow"),t.status<200||t.status>=("manual"===r?400:300))throw new Error(t.statusText)};function Or(r){var t=r.operationName;"teardown"!==t&&"production"!==process.env.NODE_ENV&&console.warn('No exchange has handled operations of type "'+t+"\". Check whether you've added an exchange responsible for these operations.")}function br(){return!1}var kr=function(r){return t(r,c(Or),a(br))},xr=function(r){return 1===r.length?r[0]:function(t){var e=t.client;return r.reduceRight(function(r,t){return t({client:e,forward:r})},t.forward)}},Er=[hr,or,yr],qr=function(r){return new Nr(r)},Nr=function(r){var t=this;this.activeOperations=Object.create(null),this.createOperationContext=function(r){var e=(r||{}).requestPolicy;return void 0===e&&(e="cache-first"),P({url:t.url,fetchOptions:t.fetchOptions},r,{requestPolicy:e})},this.createRequestOperation=function(r,e,n){return{key:e.key,query:e.query,variables:e.variables,operationName:r,context:t.createOperationContext(n)}},this.reexecuteOperation=function(r){(t.activeOperations[r.key]||0)>0&&t.dispatchOperation(r)},this.executeQuery=function(r,e){var n=t.createRequestOperation("query",r,e);return t.executeRequestOperation(n)},this.executeSubscription=function(r,e){var n=t.createRequestOperation("subscription",r,e);return t.executeRequestOperation(n)},this.executeMutation=function(r,e){var n=t.createRequestOperation("mutation",r,e);return t.executeRequestOperation(n)},this.url=r.url,this.fetchOptions=r.fetchOptions,this.suspense=!!r.suspense;var e=v(),n=e[1];this.operations$=e[0],this.dispatchOperation=n,this.exchange=xr(void 0!==r.exchanges?r.exchanges:Er),this.results$=i(this.exchange({client:this,forward:kr})(this.operations$))};Nr.prototype.onOperationStart=function(r){var t=r.key;this.activeOperations[t]=(this.activeOperations[t]||0)+1,this.dispatchOperation(r)},Nr.prototype.onOperationEnd=function(r){var t=r.key,e=this.activeOperations[t]||0;(this.activeOperations[t]=e<=0?0:e-1)<=0&&this.dispatchOperation(P({},r,{operationName:"teardown"}))},Nr.prototype.executeRequestOperation=function(i){var u=this,c=i.key,s=i.operationName,f=t(this.results$,a(function(r){return r.operation.key===c}));if("mutation"===s)return t(f,d(function(){return u.dispatchOperation(i)}),h(1));var p,v=t(f,d(function(){return u.onOperationStart(i)}),n(function(){return u.onOperationEnd(i)}));return this.suspense?(p=v,r(function(r){var i,a,u=r[1],c=!1,s=t(p,e(r[0]),n(u),o(function(r){void 0===i?a=r:c||(i(r),u(),s())}))[0];if(void 0===a)throw new Promise(function(r){i=r});return function(){c=!0,s()}})):v};var Sr=b(qr({url:"/graphql"})),_r=Sr.Provider,jr=Sr.Consumer,Pr=function(r){var t=k(!1),e=k(P({},r)),n=x(e.current),o=n[0],i=n[1],a=E(function(r){if(t.current)i(r);else{var n="function"==typeof r?r(e.current):r;P(e.current,n)}},[]);function u(){t.current=!1}return!$&&q(function(){return t.current=!0,u},[]),[o,a]},Dr=S.ReactCurrentOwner,Mr=function(r){return r&&(0===r.tag||1===r.tag||2===r.tag)},Qr=function(r){return"Query"===r.name||"Mutation"===r.name||"Subscription"===r.name};function Cr(){var r="Component",t=Dr.current;if(null!==t&&Mr(t)){var e=t.type;Qr(e)&&Mr(t._debugOwner)&&(e=t._debugOwner.type),"function"==typeof e&&(r=e.displayName||e.name||r)}return{meta:{source:r}}}var Lr,Rr="production"!==process.env.NODE_ENV&&Dr?function(){return N(Cr,[])}:function(){},Ar=function(r){var e=Rr(),n=_(Sr),o=Pr({fetching:!1,error:void 0,data:void 0}),i=o[1];function a(r){return i({fetching:!1,data:r.data,error:r.error}),r}return[o[0],E(function(o){i({fetching:!0,error:void 0,data:void 0});var u=F(r,o);return t(n.executeMutation(u,e),l).then(a)},[n,e,r,i])]},Wr=function(r,t){var e=k(void 0);return N(function(){var n=F(r,t);return void 0!==e.current&&e.current.key===n.key?e.current:(e.current=n,n)},[r,t])};function Fr(r){return P({},r,{fetching:!0})}function Ur(r){return P({},r,{fetching:!1})}!function(r){r[r.WillMount=0]="WillMount",r[r.DidMount=1]="DidMount",r[r.Update=2]="Update"}(Lr||(Lr={}));var $r=function(r){var e=Rr(),n=k(Y),i=_(Sr),a=Pr({fetching:!1,data:void 0,error:void 0}),u=a[0],c=a[1],s=Wr(r.query,r.variables);function f(r){c({fetching:!1,data:r.data,error:r.error})}var p=E(function(a){var u;n.current(),c(Fr),u=t(i.executeQuery(s,P({requestPolicy:r.requestPolicy},a,e)),o(f)),n.current=u[0]},[r.requestPolicy,i,e,s,c]);function v(){return n.current()}return function(r,t){var e=k(void 0),n=k(Lr.WillMount);n.current===Lr.WillMount&&(n.current=Lr.DidMount,e.current=r()),j(function(){return n.current===Lr.Update?e.current=r():(n.current=Lr.Update,e.current)},t)}(function(){return r.pause?(n.current(),c(Ur),Y):(p(),v)},[p,r.pause,c]),[u,p]},Tr=function(r,e){var n=Rr(),i=k(Y),a=_(Sr),u=Pr({fetching:!0,error:void 0,data:void 0}),c=u[0],s=u[1],f=Wr(r.query,r.variables);function p(r){var t=r.data,n=r.error;s(function(r){return{fetching:!0,data:void 0!==e?e(r.data,t):t,error:n}})}var v=E(function(){var r;i.current(),r=t(a.executeSubscription(f,n),o(p)),i.current=r[0]},[a,n,e,f,s]);function d(){return i.current()}return j(function(){return v(),d},[v]),[c]};function Vr(r){var t=r.children,e=Ar(r.query);return t(P({},e[0],{executeMutation:e[1]}))}function Hr(r,t){var e={};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&t.indexOf(n)<0&&(e[n]=r[n]);if(null!=r&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(r);o<n.length;o++)t.indexOf(n[o])<0&&(e[n[o]]=r[n[o]])}return e}function Ir(r){var t=r.children,e=Hr(r,["children"]),n=$r(e);return t(P({},n[0],{executeQuery:n[1]}))}function Gr(r){var t=r.children,e=r.handler,n=Hr(r,["children","handler"]);return t(Tr(n,e)[0])}export{Nr as Client,C as CombinedError,jr as Consumer,Sr as Context,Vr as Mutation,_r as Provider,Ir as Query,Gr as Subscription,or as cacheExchange,xr as composeExchanges,qr as createClient,F as createRequest,dr as debugExchange,hr as dedupExchange,Er as defaultExchanges,kr as fallbackExchangeIO,yr as fetchExchange,Z as ssrExchange,fr as subscriptionExchange,Ar as useMutation,$r as useQuery,Tr as useSubscription};
//# sourceMappingURL=urql.es.min.js.map
